---
title: "Julia vs R/Rcpp Function Comparison Tests"
format: html
engine: julia
---

# Setup

This notebook compares Julia implementations against R/Rcpp implementations to verify correctness.

## Activate Julia Environment

```{julia}
using Pkg
Pkg.activate("./julia")
```

## Environment Configuration

Lots of fiddly housekeeping stuff was needed to get RCall to work with RCppArmadillo for some reason....
Set up R environment and preload necessary DLLs:

```{julia}
# Set R_HOME to use R 4.5.1 before loading RCall
ENV["R_HOME"] = "C:/Program Files/R/R-4.5.1"

# Add R directories to PATH - this must be done BEFORE loading RCall
r_home = ENV["R_HOME"]
r_bin_x64 = joinpath(r_home, "bin", "x64")
r_bin = joinpath(r_home, "bin")

# Update PATH with R directories
if !occursin(r_bin_x64, ENV["PATH"])
    ENV["PATH"] = r_bin_x64 * ";" * r_bin * ";" * ENV["PATH"]
end

# Preload R DLLs to ensure all dependencies are available
using Base.Libc.Libdl
r_dll = joinpath(r_bin_x64, "R.dll")
rblas_dll = joinpath(r_bin_x64, "Rblas.dll")
rlapack_dll = joinpath(r_bin_x64, "Rlapack.dll")

println("Preloading R DLLs...")
dlopen(r_dll, RTLD_GLOBAL)
dlopen(rblas_dll, RTLD_GLOBAL)
dlopen(rlapack_dll, RTLD_GLOBAL)
println("‚úÖ R DLLs preloaded successfully")

# Disable problematic default packages
ENV["R_DEFAULT_PACKAGES"] = "datasets,utils,grDevices,graphics,methods"
```

## Load Packages

```{julia}
using Random
using Statistics
using LinearAlgebra
using RCall
using Test
using StatsFuns
using Distributions
using DataFrames
using RData

# Set seed for reproducible testing
Random.seed!(123)
```

## Initialize R and Load BIID Package

```{julia}

R"""
library(Rcpp)
suppressWarnings(library(RcppArmadillo))
library(BIID)
"""
```

## Load Julia Functions

```{julia}
println("üì¶ Loading Julia functions...")
include("julia/dimension_corrections.jl")
```

## Helper Functions

```{julia}
function compare_scalars(julia_result, r_result, name::String; tolerance=1e-10)
    """Compare Julia and R scalar results with tolerance"""
    try
        diff = abs(julia_result - r_result)
        if diff < tolerance
            println("‚úÖ $name: PASS (diff: $diff)")
            return true
        else
            println("‚ùå $name: FAIL (diff: $diff exceeds tolerance $tolerance)")
            println("   Julia: $julia_result")
            println("   R: $r_result")
            return false
        end
    catch e
        println("‚ùå $name: ERROR - $e")
        return false
    end
end
```

# Generate Test Data

```{julia}
println("\nüé≤ Generating test data...")

Random.seed!(123)

# Test parameters
G = 3
m = 10
maxt = 20
numTests = 4
numSeasons = 4

# Generate realistic test data
birthTimes = rand(1:5, m)
startSamplingPeriod = rand(6:15, m)
endSamplingPeriod = rand(16:20, m)
X = rand([0, 1, 3, 9], m, maxt)
# Keep TestMat as Float64 with NaN for missing values in Julia
TestMat = Float64.(rand(1:m, 50, 3 + numTests))
TestMat[:, 4:end] = rand([0.0, 1.0, NaN], 50, numTests)
thetas = rand(0.1:0.1:0.9, numTests)
rhos = rand(0.1:0.1:0.9, numTests)
phis = rand(0.1:0.1:0.9, numTests)
hp_theta = [1.0, 1.0]
hp_rho = [1.0, 1.0]
hp_xi = [81.0, 60.0]

# Create TestField and TestTimes (use CORRECTED version)
TestField = TestMatAsField_CORRECTED(TestMat, m)
TestTimes = TestTimesField(TestMat, m);
```

# Test 1: TrProbDeath_

Deterministic function - direct comparison.

```{julia}
println("\n1Ô∏è‚É£ Testing TrProbDeath_")
age = 5.0
a2 = 1.0
b2 = 1.0
c1 = 1.0
logar = false

# Julia result
julia_result = TrProbDeath_(age, a2, b2, c1, logar)
println("Julia result: ", julia_result)

# R result
@rput age a2 b2 c1 logar
r_result = R"TrProbDeath_(age, a2, b2, c1, logar)"[1]
println("R result:     ", r_result)

# Compare
diff = abs(julia_result - r_result)
println("Difference:   ", diff)
if diff < 1e-10
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 2: logisticD

Deterministic function - direct comparison.

```{julia}
println("\n2Ô∏è‚É£ Testing logisticD")
x = 0.5

# Julia result
julia_result = logisticD(x)
println("Julia result: ", julia_result)

# R result
@rput x
r_result = R"logisticD(x)"[1]
println("R result:     ", r_result)

# Compare
diff = abs(julia_result - r_result)
println("Difference:   ", diff)
if diff < 1e-10
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 3: logPostThetasRhos

Deterministic function - direct comparison.

```{julia}
println("\n3Ô∏è‚É£ Testing logPostThetasRhos")

# Julia result
julia_result = logPostThetasRhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, 
                                TestField, TestTimes, hp_theta, hp_rho)
println("Julia result: ", julia_result)

# R result
@rput thetas rhos X startSamplingPeriod endSamplingPeriod TestField TestTimes hp_theta hp_rho
r_result = R"logPostThetasRhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, TestField, TestTimes, hp_theta, hp_rho)"[1]
println("R result:     ", r_result)

# Compare
diff = abs(julia_result - r_result)
println("Difference:   ", diff)
if diff < 1e-10
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 4: gradThetasRhos

Deterministic function - vector comparison.

```{julia}
println("\n4Ô∏è‚É£ Testing gradThetasRhos")

# Julia result
julia_result = gradThetasRhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, 
                              TestField, TestTimes, hp_theta, hp_rho)
println("Julia result: ", julia_result)

# R result
@rput thetas rhos X startSamplingPeriod endSamplingPeriod TestField TestTimes hp_theta hp_rho
r_result = R"gradThetasRhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, TestField, TestTimes, hp_theta, hp_rho)"
println("R result:     ", r_result)

# Compare (vector comparison)
max_diff = maximum(abs.(julia_result .- r_result))
println("Max difference: ", max_diff)
if max_diff < 1e-10
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 5: HMC_thetas_rhos (Stochastic)

This function has random components - comparing distributions.

```{julia}
println("\n5Ô∏è‚É£ Testing HMC_thetas_rhos (Stochastic)")
println("This function has random components - comparing distributions...")

epsilonsens = 0.1
L = 5
n_samples = 10000

# Run Julia version n_samples times
println("Running Julia version $n_samples times...")
julia_results = zeros(n_samples, 2*numTests)
for i in 1:n_samples
    julia_results[i, :] = HMC_thetas_rhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, 
                                          TestField, TestTimes, hp_theta, hp_rho, epsilonsens, L)
end

# Run R version n_samples times
println("Running R version $n_samples times...")
@rput thetas rhos X startSamplingPeriod endSamplingPeriod TestField TestTimes hp_theta hp_rho epsilonsens L n_samples
R"""
r_results <- matrix(0, nrow = n_samples, ncol = length(thetas) + length(rhos))
for (i in 1:n_samples) {
    r_results[i, ] <- HMC_thetas_rhos(thetas, rhos, X, startSamplingPeriod, endSamplingPeriod, 
                                      TestField, TestTimes, hp_theta, hp_rho, epsilonsens, L)
}
"""
r_results = @rget r_results

# Compare distributions using statistical tests
println("\nDistribution comparison (mean ¬± std):")
println("-"^60)
n_params = size(julia_results, 2)
all_pass = true
for i in 1:n_params
    julia_mean = mean(julia_results[:, i])
    julia_std = std(julia_results[:, i])
    r_mean = mean(r_results[:, i])
    r_std = std(r_results[:, i])
    
    mean_diff = abs(julia_mean - r_mean)
    std_diff = abs(julia_std - r_std)
    
    # Check if means are within 3 standard errors of each other
    se = sqrt(julia_std^2 + r_std^2) / sqrt(n_samples)
    pass = mean_diff < 3 * se
    
    status = pass ? "‚úÖ" : "‚ùå"
    println("$status Param $i:")
    println("   Julia: $(round(julia_mean, digits=4)) ¬± $(round(julia_std, digits=4))")
    println("   R:     $(round(r_mean, digits=4)) ¬± $(round(r_std, digits=4))")
    println("   Mean diff: $(round(mean_diff, digits=6)), SE: $(round(se, digits=6))")
    
    if !pass
        all_pass = false
    end
end

if all_pass
    println("\n‚úÖ PASS - All distributions match statistically")
else
    println("\n‚ùå FAIL - Some distributions differ significantly")
end
```

# Test 6: TestMatAsField

Field conversion function - compare each field element.

```{julia}
println("\n6Ô∏è‚É£ Testing TestMatAsField")

# Julia result (use CORRECTED version)
julia_result = TestMatAsField_CORRECTED(TestMat, m)
println("Julia result: ", julia_result)

# R result
@rput TestMat m
R"""
r_field <- TestMatAsField(TestMat, m)
# Convert field to list of matrices for comparison
r_result_list <- lapply(r_field, function(x) matrix(x, ncol=ncol(x)))
"""
r_result = @rget r_result_list
println("R result:     ", r_result)

# Compare field arrays (need to compare each element)
println("Julia result length: ", length(julia_result))
println("R result length:     ", length(r_result))
field_match = true

if length(julia_result) != length(r_result)
    println("‚ùå FAIL - Different number of fields")
    field_match = false
else
    for i in 1:length(julia_result)
        j_field = julia_result[i]
        r_field = r_result[i]
        
        println("Field $i - Julia size: ", size(j_field), ", R size: ", size(r_field))
        
        if size(j_field) != size(r_field)
            println("  ‚ùå Size mismatch")
            field_match = false
        else
            # Compare element-wise, handling NaN and Missing
            # R's NA becomes Missing in Julia, our NaN stays as NaN
            max_diff = 0.0
            n_compared = 0
            
            for idx in CartesianIndices(j_field)
                j_val = j_field[idx]
                r_val = r_field[idx]
                
                # Check if both are missing/NaN
                j_missing = isnan(j_val)
                r_missing = ismissing(r_val) || (r_val isa Float64 && isnan(r_val))
                
                if j_missing && r_missing
                    # Both missing - OK
                    continue
                elseif j_missing || r_missing
                    # One missing, one not - FAIL
                    println("  ‚ùå Mismatch at $idx: Julia=$j_val, R=$r_val")
                    field_match = false
                    break
                else
                    # Both have values - compare
                    diff = abs(j_val - r_val)
                    max_diff = max(max_diff, diff)
                    n_compared += 1
                end
            end
            
            if n_compared > 0
                println("  Max diff: $max_diff (compared $n_compared values)")
                if max_diff > 1e-10
                    field_match = false
                end
            else
                println("  All values are missing/NaN")
            end
        end
    end
end

if field_match
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 7: logPostXi

Deterministic function - direct comparison.

```{julia}
println("\n7Ô∏è‚É£ Testing logPostXi")
xi = 15
xiMin = 10
xiMax = 20

# Julia result
julia_result = logPostXi(xiMin, xiMax, xi, hp_xi, TestField, TestTimes, thetas, rhos, phis, 
                         X, startSamplingPeriod, endSamplingPeriod)
println("Julia result: ", julia_result)

# R result
@rput xiMin xiMax xi hp_xi TestField TestTimes thetas rhos phis X startSamplingPeriod endSamplingPeriod
r_result = R"logPostXi(xiMin, xiMax, xi, hp_xi, TestField, TestTimes, thetas, rhos, phis, X, startSamplingPeriod, endSamplingPeriod)"[1]
println("R result:     ", r_result)

# Compare
diff = abs(julia_result - r_result)
println("Difference:   ", diff)
if diff < 1e-10
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Test 8: RWMH_xi (Stochastic)

This function has random components - comparing distributions.

```{julia}
println("\n8Ô∏è‚É£ Testing RWMH_xi (Stochastic)")
println("This function has random components - comparing distributions...")

# Use varied inputs to create stochastic behavior
xi_cur = 87
xi_can = 88  # Lower value to create rejection probability
n_samples = 1000

# Run Julia version n_samples times
println("Running Julia version $n_samples times...")
julia_results = zeros(n_samples)
for i in 1:n_samples
    TestField_copy = deepcopy(TestField)
    TestFieldProposal_copy = deepcopy(TestField)
    julia_results[i] = RWMH_xi(xi_can, xi_cur, hp_xi, TestFieldProposal_copy, TestField_copy, TestTimes, 
                               thetas, rhos, phis, X, startSamplingPeriod, endSamplingPeriod)
end

# Run R version n_samples times
println("Running R version $n_samples times...")
@rput xi_can xi_cur hp_xi TestField TestTimes thetas rhos phis X startSamplingPeriod endSamplingPeriod n_samples
R"""
r_results <- numeric(n_samples)
for (i in 1:n_samples) {
    TestFieldProposal <- TestField
    r_results[i] <- RWMH_xi(xi_can, xi_cur, hp_xi, TestFieldProposal, TestField, TestTimes, 
                            thetas, rhos, phis, X, startSamplingPeriod, endSamplingPeriod)
}
"""
r_results = @rget r_results

# Compare distributions
julia_mean = mean(julia_results)
julia_std = std(julia_results)
r_mean = mean(r_results)
r_std = std(r_results)

mean_diff = abs(julia_mean - r_mean)

# Handle zero variance case
if julia_std == 0 && r_std == 0
    # Both have zero variance - just check if means are equal
    pass = mean_diff < 1e-10
    println("\nDistribution comparison:")
    println("Julia: $(round(julia_mean, digits=4)) ¬± $(round(julia_std, digits=4))")
    println("R:     $(round(r_mean, digits=4)) ¬± $(round(r_std, digits=4))")
    println("Mean diff: $(round(mean_diff, digits=6))")
    if pass
        println("‚úÖ PASS - Both implementations give identical deterministic results")
    else
        println("‚ùå FAIL - Different deterministic results")
    end
else
    # Use standard error test for stochastic cases
    se = sqrt(julia_std^2 + r_std^2) / sqrt(n_samples)
    pass = mean_diff < 3 * se
    
    println("\nDistribution comparison:")
    println("Julia: $(round(julia_mean, digits=4)) ¬± $(round(julia_std, digits=4))")
    println("R:     $(round(r_mean, digits=4)) ¬± $(round(r_std, digits=4))")
    println("Mean diff: $(round(mean_diff, digits=6)), SE: $(round(se, digits=6))")
    
    if pass
        println("‚úÖ PASS")
    else
        println("‚ùå FAIL")
    end
end
```

# Test 9: TestMatAsFieldProposal

Field modification function - compare modified fields.

```{julia}
println("\n9Ô∏è‚É£ Testing TestMatAsFieldProposal")
xi = 15
xiCan = 18

# Julia version
TestFieldProposal_julia = deepcopy(TestField)
TestMatAsFieldProposal(TestFieldProposal_julia, TestField, TestTimes, xi, xiCan, m)
println("Julia result: ", TestFieldProposal_julia)

# R version
@rput TestField TestTimes xi xiCan m
R"""
TestFieldProposal_r <- TestField
TestMatAsFieldProposal(TestFieldProposal_r, TestField, TestTimes, xi, xiCan, m)
# Convert to list of matrices
TestFieldProposal_r <- lapply(TestFieldProposal_r, function(x) matrix(x, ncol=ncol(x)))
"""
TestFieldProposal_r = @rget TestFieldProposal_r
println("R result:     ", TestFieldProposal_r)

# Compare the modified TestFieldProposal
println("Julia result length: ", length(TestFieldProposal_julia))
println("R result length:     ", length(TestFieldProposal_r))
proposal_match = true

if length(TestFieldProposal_julia) != length(TestFieldProposal_r)
    println("‚ùå FAIL - Different number of fields")
    proposal_match = false
else
    for i in 1:length(TestFieldProposal_julia)
        j_field = TestFieldProposal_julia[i]
        r_field = TestFieldProposal_r[i]
        
        println("Field $i - Julia size: ", size(j_field), ", R size: ", size(r_field))
        
        if size(j_field) != size(r_field)
            println("  ‚ùå Size mismatch")
            proposal_match = false
        else
            # Compare element-wise, handling NaN and Missing
            max_diff = 0.0
            n_compared = 0
            
            for idx in CartesianIndices(j_field)
                j_val = j_field[idx]
                r_val = r_field[idx]
                
                j_missing = isnan(j_val)
                r_missing = ismissing(r_val) || (r_val isa Float64 && isnan(r_val))
                
                if j_missing && r_missing
                    continue
                elseif j_missing || r_missing
                    println("  ‚ùå Mismatch at $idx: Julia=$j_val, R=$r_val")
                    proposal_match = false
                    break
                else
                    diff = abs(j_val - r_val)
                    max_diff = max(max_diff, diff)
                    n_compared += 1
                end
            end
            
            if n_compared > 0
                println("  Max diff: $max_diff (compared $n_compared values)")
                if max_diff > 1e-10
                    proposal_match = false
                end
            else
                println("  All values are missing/NaN")
            end
        end
    end
end

if proposal_match
    println("‚úÖ PASS")
else
    println("‚ùå FAIL")
end
```

# Summary

```{julia}
println("\nüèÅ All tests completed!")
```
